<!DOCTYPE html>
<html lang="ja">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width,initial-scale=1"/>
<title>岩松県警察｜現場実況見分調書</title>
<style>
  :root{
    --bg:#0b1020; --card:#11182d; --ink:#e7ecff; --muted:#b8c0de; --border:#203058;
  }
  html,body{margin:0;background:var(--bg);color:var(--ink);
    font-family:system-ui,-apple-system,Segoe UI,Roboto,Helvetica,Arial,"Noto Sans JP","Hiragino Kaku Gothic ProN","Meiryo",sans-serif}
  .wrap{max-width:1100px;margin:24px auto;padding:16px}
  .topbar{display:flex;gap:12px;align-items:center;justify-content:space-between;margin-bottom:12px}
  h1{margin:0;font-size:1.35rem}
  .badge{background:linear-gradient(90deg,#3556a8,#2b3f7a);padding:6px 10px;border-radius:999px;border:1px solid var(--border);font-size:.85rem;color:#dfe7ff}
  .pill{padding:4px 8px;border:1px solid var(--border);border-radius:999px;font-size:.8rem;color:#c8d3ff}
  .card{background:var(--card);border:1px solid var(--border);border-radius:14px;padding:20px;margin:16px 0}
  .grid{display:grid;grid-template-columns:repeat(12,1fr);gap:16px}
  .g-12{grid-column:span 12}.g-9{grid-column:span 9}.g-8{grid-column:span 8}.g-7{grid-column:span 7}.g-6{grid-column:span 6}.g-5{grid-column:span 5}.g-4{grid-column:span 4}.g-3{grid-column:span 3}.g-2{grid-column:span 2}
  label{display:block;font-size:.85rem;color:var(--muted);margin-bottom:6px}
  input[type="text"],input[type="datetime-local"],input[type="number"],select,textarea{
    width:100%;box-sizing:border-box;background:#0c1326;color:var(--ink);
    border:1px solid var(--border);border-radius:10px;padding:10px 12px;font-size:.95rem}
  input[readonly]{opacity:.9}
  textarea{min-height:120px;resize:vertical}
  .tall{min-height:220px}
  fieldset{border:1px solid var(--border);border-radius:12px;padding:16px 18px}
  legend{color:var(--muted);font-size:.9rem;padding:0 6px}
  .row{display:flex;flex-wrap:wrap;gap:8px;align-items:center}
  .btns{display:flex;flex-wrap:wrap;gap:8px;align-items:center}
  button{background:#1a2547;color:#eaf0ff;border:1px solid var(--border);padding:10px 14px;border-radius:10px;cursor:pointer}
  button.primary{background:linear-gradient(180deg,#4b77ff,#315bdf)}
  button.ok{background:#06361e;border-color:#0c6a3a}
  button.warn{background:#3a2a00;border-color:#5e4700}
  button.ghost{background:transparent}
  .help{font-size:.8rem;color:#97a6d9}
  .hint{font-size:.8rem;color:#9fb2ff}
  .hr{height:1px;background:var(--border);margin:8px 0}
  .divider{width:1px;height:28px;background:var(--border);margin:0 6px}
  .drop{border:1px dashed var(--border);border-radius:12px;padding:18px;text-align:center;color:#cfe}
  .thumbs{display:grid;grid-template-columns:repeat(auto-fill,minmax(160px,1fr));gap:12px;margin-top:12px}
  .thumb{border:1px solid var(--border);border-radius:12px;overflow:hidden;background:#0c1326}
  .thumb img{display:block;width:100%;height:120px;object-fit:cover;background:#000}
  .thumb .cap{padding:8px}
  .thumb .tools{display:flex;gap:6px;justify-content:space-between;padding:8px}
  .thumb button{padding:6px 8px;border-radius:8px;font-size:.8rem}
  .thumb input[type="text"]{border-radius:8px}
  @media (max-width:720px){.grid{gap:18px}.g-9,.g-8,.g-7,.g-6,.g-5,.g-4,.g-3,.g-2{grid-column:span 12}}

  /* 印刷は白黒 */
  @media print{
    body{background:#fff;color:#000}
    .no-print{display:none!important}
    .card{border:1px solid #000;background:#fff;color:#000}
    input,select,textarea{border:1px solid #000;background:#fff;color:#000}
    .pill{border-color:#000;color:#000}
    .hr{background:#000}
  }

  /* PNG出力用 白地黒文字 */
  .export-light{background:#fff !important;color:#000 !important}
  .export-light *{color:#000 !important;border-color:#000 !important}
  .export-light .card{background:#fff !important;border:1px solid #000 !important}
  .export-light .hr{background:#000 !important}
  .export-light input,.export-light select,.export-light textarea{
    background:#fff !important;color:#000 !important;border:1px solid #000 !important}
</style>
<script defer src="https://cdn.jsdelivr.net/npm/html2canvas@1.4.1/dist/html2canvas.min.js"></script>
</head>
<body>
<div class="wrap">
  <div class="topbar">
    <div class="row">
      <h1>現場実況見分調書</h1>
      <span id="docId" class="pill">DOC: —</span>
    </div>
    <span class="badge">岩松県警察 / 現場入力用フォーム</span>
  </div>

  <!-- 事件基本 -->
  <div class="card">
    <div class="grid">
      <div class="g-5"><label>件名（事件名）</label><input id="caseTitle" placeholder="例：器物損壊事件（駐車場フェンス）"></div>
      <div class="g-3"><label>事故／事件種別</label>
        <select id="caseType">
          <option value="">— 選択 —</option>
          <option>交通事故</option>
          <option>物損事故</option>
          <option>人身事故</option>
          <option>盗犯（侵入・万引等）</option>
          <option>暴行・けんか</option>
          <option>騒音・駐車苦情</option>
          <option>所在不明・行方</option>
          <option>自殺関連</option>
          <option>災害・風水害</option>
          <option>警備・警戒</option>
          <option>その他</option>
        </select>
      </div>
      <div class="g-2"><label>担当所属</label><input id="aff" placeholder="例：響野署 刑事課"></div>
      <div class="g-2"><label>作成者氏名</label><input id="author" placeholder="例：岩松 太郎"></div>

      <div class="g-4"><label>発生（推定）日時</label><input id="tOccur" type="datetime-local"></div>
      <div class="g-4"><label>発見／通報日時</label><input id="tFound" type="datetime-local"></div>
      <div class="g-4"><label>現場所在地（住所・目標物）</label><input id="place" placeholder="例：響野市中央1-2-3 ○○駐車場 北側フェンス付近"></div>
    </div>
  </div>

  <!-- 対応時刻と経過 -->
  <div class="card">
    <fieldset class="g-12">
      <legend>対応時刻と経過（自動計算）</legend>
      <div class="grid">
        <div class="g-4">
          <label>通報受理時刻</label>
          <input id="tReceive" type="datetime-local">
          <div class="help">未入力時は「発見／通報日時」を使用</div>
        </div>
        <div class="g-4">
          <label>臨場（到着）時刻</label>
          <input id="tArrival" type="datetime-local">
        </div>
        <div class="g-4">
          <label>処理終了時刻</label>
          <input id="tEnd" type="datetime-local">
          <div class="help">未入力時は「作成日時」を使用</div>
        </div>

        <div class="g-4">
          <label>通報 → 臨場（分）</label>
          <input id="durReceiveToArrival" type="text" readonly>
        </div>
        <div class="g-4">
          <label>臨場 → 終了（分）</label>
          <input id="durArrivalToEnd" type="text" readonly>
        </div>
        <div class="g-4">
          <label>通報 → 終了（総経過）</label>
          <input id="durTotal" type="text" readonly>
        </div>
      </div>
    </fieldset>
  </div>

  <!-- 現場条件 -->
  <div class="card">
    <div class="grid">
      <div class="g-3"><label>天候</label><input id="weather" placeholder="例：晴れ"></div>
      <div class="g-3"><label>明るさ</label>
        <select id="light"><option>昼（明所）</option><option>夕方</option><option>夜間（街灯あり）</option><option>夜間（暗所）</option></select>
      </div>
      <div class="g-3"><label>路面・床面</label><input id="surface" placeholder="例：乾燥アスファルト"></div>
      <div class="g-3"><label>風向・風力（任意）</label><input id="wind" placeholder="例：北西 微風"></div>
    </div>
  </div>

  <!-- 関係者 -->
  <div class="card">
    <fieldset class="g-12">
      <legend>関係者</legend>
      <div class="grid">
        <div class="g-6"><label>通報者／発見者</label><input id="reporter" placeholder="例：現場管理人 佐藤次郎 090-XXXX-YYYY"></div>
        <div class="g-6"><label>被害者（施設・個人）</label><input id="victim" placeholder="例：○○パーキング 管理会社 △△"></div>
        <div class="g-6"><label>参考人（任意）</label><input id="witness" placeholder="例：近隣住民 Aさん（部屋番号○○）"></div>
        <div class="g-6"><label>関係車両等（任意）</label><input id="vehicles" placeholder="例：白色軽ワゴン（部分ナンバー○○）"></div>
      </div>
    </fieldset>
  </div>

  <!-- 現場概況 -->
  <div class="card">
    <div class="grid">
      <div class="g-12">
        <label>現場概況（初見・損壊/散乱状況・臭気・音等）</label>
        <textarea id="overview" class="tall" placeholder="例：北側フェンスの中段1スパンが切断され…"></textarea>
      </div>
      <div class="g-12">
        <label>実況経過（入退場・封鎖・採証・測定の時系列）</label>
        <textarea id="timeline" class="tall" placeholder="例：14:32 本署より臨場。14:40 封鎖テープ設置。…"></textarea>
      </div>
    </div>
  </div>

  <!-- 測定・スケッチ -->
  <div class="card">
    <div class="grid">
      <div class="g-4"><label>基準点（BM）説明</label><input id="bm" placeholder="例：駐車場北西角ポールをBMとする"></div>
      <div class="g-4"><label>方位基準</label><input id="azimuth" placeholder="例：真北を0°とする／敷地境界線基準"></div>
      <div class="g-4"><label>測定機器</label><input id="device" placeholder="例：レーザー距離計 LDM-001"></div>
      <div class="g-12">
        <label>測定記録（距離・角度・高さ等）</label>
        <textarea id="measures" class="tall" placeholder="例：BM→破断中央＝3.42m …"></textarea>
        <div class="hint">※ スケッチは別紙でも可。ここにURLや画像番号を書いてもOK。</div>
      </div>
    </div>
  </div>

  <!-- 画像アップロード -->
  <div class="card">
    <div class="grid">
      <div class="g-12">
        <label>現場写真・画像（PNG出力に転記されます）</label>
        <div id="drop" class="drop">ここに画像をドラッグ＆ドロップ（または下のボタン）<br><span class="help">JPEG/PNG、最大10枚。取り込み時に最長辺1600pxへ自動縮小します。</span></div>
        <div class="row" style="margin-top:8px">
          <input id="fileInput" type="file" accept="image/*" multiple>
          <button id="clearImages" class="warn">全部消す</button>
        </div>
        <div id="thumbs" class="thumbs"></div>
      </div>
    </div>
  </div>

  <!-- 採証・写真（テキスト） -->
  <div class="card">
    <div class="grid">
      <div class="g-6"><label>採証品（番号・内容・採取場所）</label>
        <textarea id="evidence" class="tall" placeholder="例：E-01 金属片（破断部付近）…"></textarea>
      </div>
      <div class="g-6"><label>写真・動画（管理番号・内容）</label>
        <textarea id="photos" class="tall" placeholder="例：P-001 全景（北→南）…"></textarea>
      </div>
      <div class="g-12"><label>付記（安全配慮・留意・その他）</label><textarea id="note"></textarea></div>
    </div>
  </div>

  <!-- 立会・署名 -->
  <div class="card">
    <div class="grid">
      <div class="g-6"><label>立会者（氏名・属性）</label><input id="attendee" placeholder="例：管理会社担当 山田花子"></div>
      <div class="g-6"><label>作成日時</label><input id="tMade" type="datetime-local"></div>
      <div class="g-6"><label>作成者職員番号（任意）</label><input id="staffNo" inputmode="numeric" placeholder="例：123456"></div>
      <div class="g-6"><label>署名欄（記載者名）</label><input id="sign" placeholder="例：岩松 太郎"></div>
    </div>
  </div>

  <!-- 操作 -->
  <div class="card no-print">
    <div class="btns">
      <button class="primary" id="btnPreview">プレビュー/印刷</button>
      <button class="ok" id="btnSave">下書きを保存</button>
      <button id="btnLoad">下書きを読込</button>
      <button id="btnJSON">JSONを書き出し</button>
      <button class="ghost" id="btnMD">Markdownをコピー</button>
      <button id="btnPNG">PNGを書き出し</button>

      <span class="divider"></span>
      <span class="row">
        <label class="help" for="demoSelect">記入例:</label>
        <select id="demoSelect">
          <option value="vandal">器物損壊（フェンス切断）</option>
          <option value="burglary">侵入盗（窓ガラス破壊）</option>
          <option value="hitrun">当て逃げ（駐車場単独）</option>
        </select>
        <button id="btnDemoApply">適用</button>
        <button id="btnDemoRandom">ランダム</button>
        <button id="btnDemoClear">例をクリア</button>
      </span>
    </div>
  </div>

  <!-- プレビュー -->
  <div class="card" id="preview" style="display:none">
    <div id="previewBody"></div>
  </div>
</div>

<script>
  const $ = (q)=>document.querySelector(q);
  const FIELDS = [
    'caseTitle','caseType','aff','author','tOccur','tFound','place',
    'tReceive','tArrival','tEnd', // 対応時刻
    'weather','light','surface','wind','reporter','victim','witness','vehicles',
    'overview','timeline','bm','azimuth','device','measures','evidence','photos','note',
    'attendee','tMade','staffNo','sign'
  ];
  const LSKEY='iwamatsu_genba_jikkou_kenbun_v3';
  const IMGKEY='iwamatsu_genba_images_v1'; // 画像は別キーに保持
  let images = []; // {src, name, caption}

  function genId(){ const d=new Date(),p=n=>String(n).padStart(2,'0');
    return `GK-${d.getFullYear().toString().slice(-2)}${p(d.getMonth()+1)}${p(d.getDate())}-${p(d.getHours())}${p(d.getMinutes())}`;}
  function setDocId(){ $('#docId').textContent='DOC: '+genId(); }
  function formatDT(s){ if(!s) return ''; return String(s).replace('T',' ').replace(/:\d\d$/,''); }
  function toDate(s){ return s? new Date(s): null; }

  function toObj(){
    const o={}; FIELDS.forEach(k=>{
      const el=$('#'+k);
      o[k]= el instanceof HTMLTextAreaElement ? el.value.trim() : (el?.value || '');
    });
    o.docId = $('#docId').textContent.replace('DOC: ','');
    o.images = images;
    // 付帯：経過時間を保存用に含める
    const d=calcDurations();
    o.durations = d;
    return o;
  }
  function applyObj(o){
    FIELDS.forEach(k=> { if($('#'+k)) $('#'+k).value = o[k] ?? ''; });
    images = Array.isArray(o.images) ? o.images : [];
    renderThumbs();
    renderDurations(calcDurations());
  }
  function validate(o){
    const need=['caseTitle','aff','author','place','tFound'];
    const miss=need.filter(k=>!o[k]); if(miss.length){ alert('未入力があります：'+miss.join(', ')); return false; }
    return true;
  }

  function minsToHM(mins){
    if(mins==null || isNaN(mins)) return '';
    const sign = mins<0?'-':'';
    const m = Math.abs(mins);
    const h = Math.floor(m/60), mm = m%60;
    if(h===0) return `${sign}${mm}分`;
    return `${sign}${h}時間${mm}分`;
  }

  function calcDurations(){
    const tFound = toDate($('#tReceive').value || $('#tFound').value || '');
    const tArrival = toDate($('#tArrival').value || '');
    const tEnd = toDate($('#tEnd').value || $('#tMade').value || '');
    const diff = (a,b)=> (a&&b)? Math.round((a-b)/60000) : null; // minutes
    return {
      receiveToArrival: diff(tArrival,tFound),
      arrivalToEnd: diff(tEnd,tArrival),
      total: diff(tEnd,tFound)
    };
  }
  function renderDurations(d){
    $('#durReceiveToArrival').value = d.receiveToArrival!=null ? minsToHM(d.receiveToArrival) : '';
    $('#durArrivalToEnd').value = d.arrivalToEnd!=null ? minsToHM(d.arrivalToEnd) : '';
    $('#durTotal').value = d.total!=null ? minsToHM(d.total) : '';
  }

  function toMarkdown(o){
    const imgs = (o.images||[]).map((im,i)=>`- 画像${i+1}: ${im.name||'image'}（${im.caption||''}）`).join('\n');
    const d = o.durations || calcDurations();
    return `# 現場実況見分調書（${o.docId}）\n\n`+
    `**件名**: ${o.caseTitle}　**種別**: ${o.caseType||'—'}\n`+
    `**担当所属**: ${o.aff}　**作成者**: ${o.author}　**作成日時**: ${formatDT(o.tMade)}　**職員番号**: ${o.staffNo||'—'}\n\n`+
    `**発生（推定）**: ${formatDT(o.tOccur)}　**発見/通報**: ${formatDT(o.tFound)}\n`+
    `**所在地**: ${o.place}\n\n`+
    `## 対応時刻・経過\n`+
    `- 通報受理: ${formatDT(o.tReceive||o.tFound)}　臨場: ${formatDT(o.tArrival)}　終了: ${formatDT(o.tEnd||o.tMade)}\n`+
    `- 経過: 通報→臨場 ${minsToHM(d.receiveToArrival)} ／ 臨場→終了 ${minsToHM(d.arrivalToEnd)} ／ 総経過 ${minsToHM(d.total)}\n\n`+
    `**天候**: ${o.weather||''}　**明るさ**: ${o.light||''}　**路面**: ${o.surface||''}　**風**: ${o.wind||''}\n\n`+
    `**関係者**\n- 通報者/発見者: ${o.reporter||''}\n- 被害者: ${o.victim||''}\n- 参考人: ${o.witness||''}\n- 関係車両: ${o.vehicles||''}\n\n`+
    `## 現場概況\n${o.overview||''}\n\n`+
    `## 実況経過（時系列）\n${o.timeline||''}\n\n`+
    `## 測定\n- 基準点: ${o.bm||''}\n- 方位基準: ${o.azimuth||''}\n- 測定機器: ${o.device||''}\n- 記録:\n${o.measures||''}\n\n`+
    `## 画像\n${imgs||'（なし）'}\n\n`+
    `## 採証品\n${o.evidence||''}\n\n`+
    `## 写真・動画（テキスト）\n${o.photos||''}\n\n`+
    `## 付記\n${o.note||''}\n\n`+
    `**立会者**: ${o.attendee||''}　**署名**: ${o.sign||''}\n`;
  }

  function renderPreview(o){
    const esc=s=>String(s||'').replace(/[&<>]/g,c=>({'&':'&amp;','<':'&lt;','>':'&gt;'}[c]));
    const nl2br=s=>String(s||'').replace(/\n/g,'<br>');
    const imgHtml = (o.images||[]).map((im,i)=>`
      <div style="break-inside:avoid; margin:0 0 12px 0; border:1px solid #666; border-radius:8px; overflow:hidden;">
        <div style="padding:6px 10px; font-weight:600">画像${i+1}：${esc(im.name||'image')}</div>
        <img src="${im.src}" alt="img${i+1}" style="display:block;width:100%;max-height:420px;object-fit:contain;background:#000">
        <div style="padding:8px 10px;font-size:.9rem;color:#222">キャプション：${esc(im.caption||'')}</div>
      </div>
    `).join('');

    const d = calcDurations();

    const h = `
      <div class="grid">
        <div class="g-12"><strong>${o.docId}</strong></div>
        <div class="g-12">件名：${esc(o.caseTitle)}／種別：${esc(o.caseType||'—')}</div>
        <div class="g-12">担当所属：${esc(o.aff)}／作成者：${esc(o.author)}／作成日時：${esc(formatDT(o.tMade))}／職員番号：${esc(o.staffNo||'—')}</div>
        <div class="g-12">発生（推定）：${esc(formatDT(o.tOccur))}　発見/通報：${esc(formatDT(o.tFound))}</div>
        <div class="g-12">所在地：${esc(o.place)}</div>
      </div>
      <div class="hr"></div>

      <div class="grid">
        <div class="g-12"><strong>対応時刻・経過</strong></div>
        <div class="g-12">
          通報受理：${esc(formatDT(o.tReceive||o.tFound))} ／ 臨場：${esc(formatDT(o.tArrival))} ／ 終了：${esc(formatDT(o.tEnd||o.tMade))}<br>
          経過：通報→臨場 <strong>${esc(minsToHM(d.receiveToArrival))}</strong> ／ 臨場→終了 <strong>${esc(minsToHM(d.arrivalToEnd))}</strong> ／ 総経過 <strong>${esc(minsToHM(d.total))}</strong>
        </div>
      </div>
      <div class="hr"></div>

      <div class="grid">
        <div class="g-12">天候：${esc(o.weather)}　明るさ：${esc(o.light)}　路面：${esc(o.surface)}　風：${esc(o.wind)}</div>
      </div>
      <div class="hr"></div>

      <div class="grid">
        <div class="g-12"><strong>関係者</strong>／通報者：${esc(o.reporter)}／被害者：${esc(o.victim)}／参考人：${esc(o.witness)}／関係車両：${esc(o.vehicles)}</div>
      </div>
      <div class="hr"></div>

      <div class="grid">
        <div class="g-12"><strong>現場概況</strong><br>${nl2br(esc(o.overview))}</div>
        <div class="g-12"><strong>実況経過（時系列）</strong><br>${nl2br(esc(o.timeline))}</div>
      </div>
      <div class="hr"></div>

      <div class="grid">
        <div class="g-12"><strong>測定</strong>（基準点：${esc(o.bm)}／方位基準：${esc(o.azimuth)}／機器：${esc(o.device)}）<br>${nl2br(esc(o.measures))}</div>
      </div>
      <div class="hr"></div>

      <div class="grid">
        <div class="g-12"><strong>画像（アップロード）</strong></div>
        <div class="g-12">${imgHtml || '<span class="help">（画像なし）</span>'}</div>
      </div>
      <div class="hr"></div>

      <div class="grid">
        <div class="g-6"><strong>採証品</strong><br>${nl2br(esc(o.evidence))}</div>
        <div class="g-6"><strong>写真・動画（テキスト）</strong><br>${nl2br(esc(o.photos))}</div>
        <div class="g-12"><strong>付記</strong><br>${nl2br(esc(o.note))}</div>
        <div class="g-12"><strong>立会者</strong>：${esc(o.attendee)}　<strong>署名</strong>：${esc(o.sign)}</div>
      </div>`;
    $('#previewBody').innerHTML=h;
    $('#preview').style.display='block';
    window.scrollTo({top:document.body.scrollHeight,behavior:'smooth'});
  }

  // ========= 下書き/書き出し =========
  function saveDraft(){
    const o=toObj();
    localStorage.setItem(LSKEY, JSON.stringify(o));
    alert('下書きを保存しました（画像含む）');
  }
  function loadDraft(){
    const raw=localStorage.getItem(LSKEY); if(!raw){ alert('保存された下書きはありません'); return; }
    const o=JSON.parse(raw); applyObj(o);
    $('#docId').textContent='DOC: '+(o.docId || genId());
    alert('下書きを読み込みました');
  }
  function exportJSON(){
    const o=toObj(); if(!validate(o)) return;
    const a=document.createElement('a');
    a.href=URL.createObjectURL(new Blob([JSON.stringify(o,null,2)],{type:'application/json'}));
    a.download=`${o.docId}.json`; a.click(); URL.revokeObjectURL(a.href);
  }
  async function copyMD(){
    const o=toObj(); if(!validate(o)) return;
    const md=toMarkdown(o);
    try{ await navigator.clipboard.writeText(md); alert('Markdownをコピーしました'); }
    catch{ const ta=document.createElement('textarea'); ta.value=md; document.body.appendChild(ta); ta.select(); document.execCommand('copy'); ta.remove(); alert('Markdownをコピーしました（代替）'); }
  }
  async function exportPNG(){
    if($('#preview').style.display==='none'){ alert('先に「プレビュー/印刷」を押してください'); return; }
    document.body.classList.add('export-light');
    await new Promise(r=>requestAnimationFrame(r));
    const canvas=await html2canvas($('#previewBody'),{scale:2,backgroundColor:'#ffffff',useCORS:true});
    const a=document.createElement('a'); a.href=canvas.toDataURL('image/png'); a.download=`${$('#docId').textContent.replace('DOC: ','')}.png`; a.click();
    document.body.classList.remove('export-light');
  }

  // ========= 画像モジュール =========
  const drop = $('#drop');
  const fileInput = $('#fileInput');
  const thumbs = $('#thumbs');
  $('#clearImages').addEventListener('click', ()=>{
    if(!confirm('画像をすべて削除しますか？')) return;
    images=[]; persistImages(); renderThumbs();
  });
  ;['dragenter','dragover'].forEach(ev=> drop.addEventListener(ev, e=>{ e.preventDefault(); drop.style.background='rgba(80,120,255,.1)';}));
  ;['dragleave','drop'].forEach(ev=> drop.addEventListener(ev, e=>{ e.preventDefault(); drop.style.background='transparent';}));
  drop.addEventListener('drop', e=>{
    const files=[...(e.dataTransfer?.files||[])].filter(f=>f.type.startsWith('image/'));
    if(files.length) handleFiles(files);
  });
  fileInput.addEventListener('change', e=>{
    const files=[...(e.target.files||[])].filter(f=>f.type.startsWith('image/'));
    if(files.length) handleFiles(files);
    fileInput.value='';
  });
  function persistImages(){ localStorage.setItem(IMGKEY, JSON.stringify(images)); }
  function loadImages(){ try{ const arr=JSON.parse(localStorage.getItem(IMGKEY)||'[]'); if(Array.isArray(arr)) images=arr; }catch{} }
  async function handleFiles(files){
    if(images.length + files.length > 10){ alert('最大10枚までです'); return; }
    for(const f of files){
      const data = await resizeToDataURL(f,1600);
      images.push({src:data, name:f.name, caption:''});
    }
    persistImages();
    renderThumbs();
  }
  function renderThumbs(){
    thumbs.innerHTML='';
    images.forEach((im,idx)=>{
      const div=document.createElement('div');
      div.className='thumb';
      div.innerHTML=`
        <img src="${im.src}" alt="img${idx+1}">
        <div class="cap"><input type="text" placeholder="キャプション（任意）" value="${(im.caption||'').replace(/"/g,'&quot;')}"></div>
        <div class="tools">
          <div class="row">
            <button data-act="up">↑</button>
            <button data-act="down">↓</button>
            <button data-act="del" class="warn">削除</button>
          </div>
          <span class="help">画像${idx+1}</span>
        </div>`;
      const capInput = div.querySelector('input');
      capInput.addEventListener('change', e=>{ images[idx].caption=e.target.value; persistImages(); });
      div.querySelector('[data-act="up"]').addEventListener('click', ()=>{
        if(idx===0) return; const t=images[idx]; images[idx]=images[idx-1]; images[idx-1]=t; persistImages(); renderThumbs();
      });
      div.querySelector('[data-act="down"]').addEventListener('click', ()=>{
        if(idx===images.length-1) return; const t=images[idx]; images[idx]=images[idx+1]; images[idx+1]=t; persistImages(); renderThumbs();
      });
      div.querySelector('[data-act="del"]').addEventListener('click', ()=>{
        images.splice(idx,1); persistImages(); renderThumbs();
      });
      thumbs.appendChild(div);
    });
  }
  function resizeToDataURL(file,maxEdge){
    return new Promise((res,rej)=>{
      const fr=new FileReader();
      fr.onload=()=>{
        const img=new Image();
        img.onload=()=>{
          let {width:w,height:h}=img;
          const scale = Math.min(1, maxEdge/Math.max(w,h));
          const nw = Math.round(w*scale), nh = Math.round(h*scale);
          const cv=document.createElement('canvas'); cv.width=nw; cv.height=nh;
          const cx=cv.getContext('2d'); cx.drawImage(img,0,0,nw,nh);
          const out = cv.toDataURL('image/jpeg',0.9);
          res(out);
        };
        img.onerror=rej;
        img.src=fr.result;
      };
      fr.onerror=rej;
      fr.readAsDataURL(file);
    });
  }

  // ========= 記入例 =========
  const demos={
    vandal:()=>({
      caseTitle:'器物損壊事件（駐車場フェンス）', caseType:'盗犯（侵入・万引等）', aff:'響野署 刑事課', author:'岩松 太郎',
      tOccur:'', tFound:isoNow(), place:'響野市中央1-2-3 ○○駐車場 北側フェンス付近',
      tReceive:'', tArrival:'', tEnd:'',
      weather:'晴れ', light:'昼（明所）', surface:'乾燥アスファルト', wind:'北西 微風',
      reporter:'管理人 佐藤次郎 090-XXXX-YYYY', victim:'○○パーキング 管理会社 △△', witness:'—', vehicles:'—',
      overview:`北側フェンス中段1スパン切断。切断面は新鮮で錆なし。周辺に切屑なし。内側に足跡様汚れ少量。`,
      timeline:`14:32 本署より臨場。14:40 封鎖設置。14:45 採証開始（指紋・足跡）。15:05 測定（BM設定）。15:30 終了。`,
      bm:'北西角ポール', azimuth:'真北を0°', device:'レーザー距離計 LDM-001',
      measures:`BM→破断中央 3.42m／支柱間隔 2.00m／破断高さ 地表1.10m`,
      evidence:`E-01 金属片（破断部付近）\nE-02 茶色繊維（破断部）`,
      photos:`P-001 全景（北→南）\nP-002 破断部近接\nP-003 足跡様汚れ`,
      note:'付近聞込みは別紙記録', attendee:'管理会社 山田花子', tMade:isoNow(), staffNo:'', sign:'岩松 太郎'
    }),
    burglary:()=>({
      caseTitle:'建造物侵入・窃盗（窓ガラス破壊）', caseType:'盗犯（侵入・万引等）', aff:'響野署 刑事課', author:'岩松 太郎',
      tOccur:'', tFound:isoNow(), place:'響野市青葉町2-5-10 一戸建て南側窓',
      tReceive:'', tArrival:'', tEnd:'',
      weather:'曇り', light:'夕方', surface:'乾燥コンクリート', wind:'西 弱風',
      reporter:'住人 A 080-XXXX-YYYY', victim:'住人 A', witness:'向かい住民 B（物音聴取）', vehicles:'—',
      overview:`南側腰窓のガラス割れ（内側散乱多）。こじ開け痕あり。室内は物色状況。`,
      timeline:`17:05 通報受理。17:25 臨場。17:35 封鎖。17:40 採証（破片/こじ開け痕）。18:10 測定・撮影。`,
      bm:'門柱根元', azimuth:'敷地境界線基準', device:'スチールテープ',
      measures:`BM→窓中心 4.80m／窓高 地表1.00m／破片散乱範囲 1.5×2.0m`,
      evidence:`E-01 破片（室内側）\nE-02 マイナスドライバー痕擦過片`,
      photos:`P-001 外観全景\nP-002 窓破損部近接\nP-003 室内散乱状況`,
      note:'隣接監視カメラの確認は後刻実施', attendee:'被害者 A', tMade:isoNow(), staffNo:'', sign:'岩松 太郎'
    }),
    hitrun:()=>({
      caseTitle:'当て逃げ（駐車場・単独）', caseType:'交通事故', aff:'響野署 交通課', author:'岩松 太郎',
      tOccur:'', tFound:isoNow(), place:'響野市駅前2-1-5 商業施設駐車場',
      tReceive:'', tArrival:'', tEnd:'',
      weather:'小雨', light:'夜間（街灯あり）', surface:'湿潤アスファルト', wind:'東 微風',
      reporter:'被害車両運転者 C 070-XXXX-YYYY', victim:'C', witness:'防犯カメラ映像あり（後日押収）', vehicles:'相手不詳（黒色セダンの可能性）',
      overview:`被害車両右後部バンパーに擦過傷。破片や塗膜片少量。スリップ痕なし。`,
      timeline:`20:10 通報受理。20:25 臨場。20:35 採証（塗膜片）。20:50 測定・撮影。`,
      bm:'A列車止め角', azimuth:'駐車区画線基準', device:'メジャー',
      measures:`BM→被害車両後端 2.10m／衝突角度推定 約20〜30°`,
      evidence:`E-01 黒色塗膜片\nE-02 プラスチック破片（小）`,
      photos:`P-001 被害車両全景\nP-002 損傷部近接\nP-003 駐車枠周辺`,
      note:'施設管理者の録画データ保全依頼済', attendee:'施設管理者 D', tMade:isoNow(), staffNo:'', sign:'岩松 太郎'
    })
  };
  function isoNow(){ const d=new Date(); return new Date(d.getTime()-d.getTimezoneOffset()*60000).toISOString().slice(0,16); }
  function applyDemo(key){
    const t=demos[key]?.(); if(!t) return;
    FIELDS.forEach(k=> { if($('#'+k)) $('#'+k).value=t[k]??''; });
    renderDurations(calcDurations());
  }
  function applyRandom(){ const ks=Object.keys(demos); applyDemo(ks[Math.floor(Math.random()*ks.length)]); }
  function clearDemo(){
    ['overview','timeline','measures','evidence','photos','note','reporter','victim','witness','vehicles','bm','azimuth','device']
      .forEach(id=> $('#'+id).value='');
    renderDurations(calcDurations());
  }

  // ========= イベント =========
  $('#btnPreview').addEventListener('click', ()=>{ const o=toObj(); if(validate(o)) renderPreview(o); });
  $('#btnSave').addEventListener('click', saveDraft);
  $('#btnLoad').addEventListener('click', loadDraft);
  $('#btnJSON').addEventListener('click', exportJSON);
  $('#btnMD').addEventListener('click', copyMD);
  $('#btnPNG').addEventListener('click', exportPNG);

  $('#btnDemoApply').addEventListener('click', ()=> applyDemo($('#demoSelect').value));
  $('#btnDemoRandom').addEventListener('click', applyRandom);
  $('#btnDemoClear').addEventListener('click', clearDemo);

  // 対応時刻の入力で自動再計算
  ['tReceive','tArrival','tEnd','tFound','tMade'].forEach(id=>{
    $('#'+id).addEventListener('change', ()=> renderDurations(calcDurations()));
  });

  // ========= 初期化 =========
  setDocId();
  const now=new Date(); const isoLocal=new Date(now.getTime()-now.getTimezoneOffset()*60000).toISOString().slice(0,16);
  $('#tFound').value=isoLocal; $('#tMade').value=isoLocal;
  // デフォルト：通報受理＝tFound、終了＝tMade
  $('#tReceive').value=''; $('#tEnd').value='';

  // 画像の復元
  loadImages(); renderThumbs();
  renderDurations(calcDurations());
</script>
</body>
</html>
